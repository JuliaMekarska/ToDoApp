<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>ToDo App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="contents">
    <h1>ToDo App</h1>

    <div class="field">
        <input class="textField" type="text" id="taskInput" placeholder="New task">
        <select id="typeSelect"></select>
        <button class="addButton" onclick="addToDo()">Add Task</button>
    </div>

    <div id="todoContainer"></div>
</div>
<script>
    const TODO_API = "/api/todo";
    const TYPE_API = "/api/type";

    async function loadTypes() {
        const res = await fetch(TYPE_API);
        const types = await res.json();
        const select = document.getElementById("typeSelect");
        select.innerHTML = "";
        types.forEach(t => {
            const option = document.createElement("option");
            option.value = t.id;
            option.textContent = t.name;
            select.appendChild(option);
        });
    }

    async function loadToDos() {
        const res = await fetch(TODO_API);
        const todos = await res.json();
        const container = document.getElementById("todoContainer");
        container.innerHTML = "";

        // grupowanie po typie
        const grouped = {};
        todos.forEach(todo => {
            const typeName = todo.type ? todo.type.name : "Bez typu";
            if (!grouped[typeName]) grouped[typeName] = [];
            grouped[typeName].push(todo);
        });

        for (const [typeName, tasks] of Object.entries(grouped)) {
            const block = document.createElement("div");
            block.classList.add("type-block");

            const title = document.createElement("div");
            title.classList.add("type-title");
            title.textContent = typeName;
            block.appendChild(title);

            const ul = document.createElement("ul");
            tasks.forEach(todo => {
                const li = document.createElement("li");
                li.textContent = `${todo.name}`;
                if (todo.completed) li.classList.add("completed");

                const completeBtn = document.createElement("button");
                completeBtn.textContent = "âœ”";
                completeBtn.onclick = () => updateToDo(todo.id);

                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "ðŸ—‘";
                deleteBtn.onclick = () => deleteToDo(todo.id);

                li.appendChild(completeBtn);
                li.appendChild(deleteBtn);

                ul.appendChild(li);
            });

            block.appendChild(ul);
            container.appendChild(block);
        }
    }

    async function addToDo() {
        const task = document.getElementById("taskInput").value;
        const typeId = document.getElementById("typeSelect").value;
        if (!task.trim()) return;
        await fetch(TODO_API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                name: task,
                completed: false,
                type: { id: typeId }
            })
        });
        document.getElementById("taskInput").value = "";
        loadToDos();
    }

    async function updateToDo(id) {
        await fetch(`${TODO_API}/${id}`, { method: "PUT" });
        loadToDos();
    }

    async function deleteToDo(id) {
        await fetch(`${TODO_API}/${id}`, { method: "DELETE" });
        loadToDos();
    }

    loadTypes();
    loadToDos();
</script>
</body>
</html>
